package com.mmdb.rest.performance;

import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.restlet.data.Form;
import org.restlet.ext.json.JsonRepresentation;
import org.restlet.representation.Representation;
import org.restlet.resource.Delete;
import org.restlet.resource.Post;
import org.restlet.resource.ServerResource;

import com.mmdb.model.bean.ChartBean;
import com.mmdb.model.bean.ChartData;
import com.mmdb.model.bean.Page;
import com.mmdb.model.bean.PerformanceBean;
import com.mmdb.service.performance.IPerformanceService;
import com.mmdb.service.performance.impl.PerformanceService;

public class PerformanceRestService extends ServerResource{
	
	private IPerformanceService service = new PerformanceService();
	
	@Delete
	public Representation get(Representation entity) {
		boolean flag = service.deleteAll();
		return null;
	}
					
	@Override
	@SuppressWarnings({ "rawtypes", "unchecked" })
	@Post
	public Representation post(Representation entity) {
		Form form = new Form(entity);  
		String operation = null;
		int start = 0;
		int limit = 300;
		String ciId = "";
		String ciCategory  = "";
		String startTime = "";
		String endTime = "";
		String kpiCategory = "";
		String kpi = "";
		String kpiInstance = "";
		String chart = (String) getRequestAttributes().get("chart");
		try {
			operation = URLDecoder.decode(form.getQueryString(),"utf-8");
			operation = new String(operation.getBytes("iso-8859-1"),"utf-8");
			JSONObject json = JSONObject.fromObject(operation);	
			System.out.println(operation);
			start = json.containsKey("start") == false ? start : Integer.parseInt(json.getString("start"));
			limit = json.containsKey("limit") == false ? limit : Integer.parseInt(json.getString("limit"));
			ciId = json.containsKey("ci") == false ? ciId : json.getString("ci");
			ciCategory = json.containsKey("ciCate") == false ? ciCategory : json.getString("ciCate");
			kpi = json.containsKey("kpi") == false ? kpi : json.getString("kpi");
			kpiCategory = json.containsKey("kpiCate") == false ? kpiCategory : json.getString("kpiCate");
			kpiInstance = json.containsKey("kpiInstance") == false ? kpiInstance : json.getString("kpiInstance");
			startTime = (json.containsKey("startTime") == false &&  json.getString("startTime").length() >0 && json.getString("startTime").equals("null")) ? startTime : json.getString("startTime");
			endTime = (json.containsKey("endTime") == false &&  json.getString("endTime").length() >0 && json.getString("endTime").equals("null")) ? endTime : json.getString("endTime");
			if(chart != null){
				chart = URLDecoder.decode(chart, "utf-8");
			}else{
				chart = "";
			}
		}catch(Exception e){
			//e.printStackTrace();
		}
		
	    if(chart.equals("chart")){
	    	Map<Integer,List<PerformanceBean>> map = service.getAllPerformanceDatasByInstance(ciCategory, ciId, kpiCategory, kpi, kpiInstance,startTime, endTime, start, limit);
		    Integer total = map.keySet().iterator().next();
		    List<PerformanceBean> list = map.get(total);
	    	  String ciName ="";
	    	  String kpiName = "";
	    	  limit = 100000;
	    	   Map<String,List<ChartBean>> cmap = new HashMap<String,List<ChartBean>>();
			    for(PerformanceBean b : list){
			    	ciName = b.getCiName();
			    	kpiName = b.getKpiName();
		    		//ChartBean chartBean = new ChartBean(b.getStartTime().substring(11,16),b.getValue());
			    	ChartBean chartBean = new ChartBean(b.getStartTime(),b.getValue());
		    		String inst = b.getInstance();
		    		if(inst == null || inst.equals("null") || inst.length() == 0){
		    			if(cmap.get(b.getKpiName()) == null){
			    			List<ChartBean> chartBeans = new ArrayList<ChartBean>();
			    			chartBeans.add(chartBean);
			    			cmap.put(b.getKpiName(), chartBeans);
			    		}else{
			    			cmap.get(b.getKpiName()).add(chartBean);
			    		}
		    		}else{
			    		if(cmap.get(inst) == null){
			    			List<ChartBean> chartBeans = new ArrayList<ChartBean>();
			    			chartBeans.add(chartBean);
			    			cmap.put(inst, chartBeans);
			    		}else{
			    			cmap.get(inst).add(chartBean);
			    		}
		    		}
			    }
			    ChartData data = new ChartData();
			    data.setTitle(ciName);
			    data.setSubTitle(kpiName);
			    data.setIndex(0);
			    JSONArray array = new JSONArray();
			    Iterator<String> it = cmap.keySet().iterator();
			    while(it.hasNext()){
			    	String inst = it.next();
			    	List<ChartBean> bs = cmap.get(inst);
			    	JSONObject jsonv = new JSONObject();
			    	jsonv.put("inst", inst);
/*			    	jsonv.put("color", "#000"); //控制线的颜色
			    	jsonv.put("hideInLegend", false); //控制图表名称是否隐藏
			    	jsonv.put("hideVisible", false); //控制图表是否隐藏
*/			    	jsonv.put("value", JSONArray.fromObject(bs).toString());
			    	array.add(jsonv);
			    }
			    data.setValues(array.toString());
			    Map<String,ChartData> res = new HashMap<String,ChartData>();
				res.put("datas", data);
				return new JsonRepresentation(JSONObject.fromObject(res));  	
	    }else{
	    	
	    	Map<Integer,List<PerformanceBean>> map = service.getPerformaceDatas(startTime,endTime,start, limit);
		    Integer total = map.keySet().iterator().next();
		    List<PerformanceBean> list = map.get(total);
	    	Page page = new Page(list);
			page.setStart(start);
			page.setPageSize(limit);
			page.setTotalCount(total);
			return new JsonRepresentation(JSONObject.fromObject(page));
	    }
	}	
}
