package com.mmdb.rest.rule;

import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.util.List;
import java.util.Map;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.restlet.Context;
import org.restlet.Request;
import org.restlet.Response;
import org.restlet.data.Form;
import org.restlet.data.Status;
import org.restlet.ext.json.JsonRepresentation;
import org.restlet.representation.Representation;
import org.restlet.resource.Delete;
import org.restlet.resource.Get;
import org.restlet.resource.Post;
import org.restlet.resource.Put;
import org.restlet.resource.ServerResource;

import com.mmdb.core.log.Log;
import com.mmdb.core.log.LogFactory;
import com.mmdb.core.utils.SpringContextUtil;
import com.mmdb.model.rule.LinkRule;
import com.mmdb.model.rule.RuleUtil;
import com.mmdb.service.ruleEngine.ILinkRuleService;

/**
 * 性能数据匹配CI的Rest
 * 
 * @author yuhao.guan
 * @version 1.0 2015-7-7
 *
 */
public class LinkRuleRest extends ServerResource {
	private Log log = LogFactory.getLogger("Link2CiRuleRest");
	
	private ILinkRuleService linkRuleService;
	
	@Override
	public void init(Context context, Request request, Response response) {
		super.init(context, request, response);
		linkRuleService = (ILinkRuleService) SpringContextUtil
				.getApplicationContext().getBean("linkRuleService");
	}
	
	@Get
	public Representation getMethod(Representation entity) {
		JSONObject ret = new JSONObject();
		String param1 = (String) getRequestAttributes().get("param1");
		if (param1 != null) {
			try {
				param1 = URLDecoder.decode(param1, "utf-8");
			} catch (UnsupportedEncodingException e) {
				log.eLog(e);
				ret.put("message", "[" + param1 + "]解析失败");
				getResponse().setStatus(new Status(600));
				return new JsonRepresentation(ret.toString());
			}
		}

		if (param1 == null || "".equals(param1)) {
			return getRulesByType(RuleUtil.PERF_LINK_CI);
		} else if (RuleUtil.PERF_LINK_CI.equals(param1)) {
			//获取CI匹配规则
			return getRulesByType(RuleUtil.PERF_LINK_CI);
		} else if (RuleUtil.PERF_LINK_KPI.equals(param1)) {
			//获取KPI匹配规则
			return getRulesByType(RuleUtil.PERF_LINK_KPI);
		} else {
			//获取指定ID的匹配规则
			return getRuleById(param1);
		}
	}
	
	@Post
	public Representation postMethod(Representation entity) {
		JSONObject ret = new JSONObject();
		String param1 = (String) getRequestAttributes().get("param1");
		if (param1 != null) {
			try {
				param1 = URLDecoder.decode(param1, "utf-8");
			} catch (UnsupportedEncodingException e) {
				log.eLog(e);
				ret.put("message", "[" + param1 + "]解析失败");
				getResponse().setStatus(new Status(600));
			}
		}

		String operation = null;
		try {
			if ("import".equals(param1)) {
				//return new JsonRepresentation(importData(entity));
			}

			Form form = entity == null ? null : new Form(entity);
			operation = form.getQueryString();
			operation = URLDecoder.decode(operation, "utf-8");
			operation = new String(operation.getBytes("iso-8859-1"), "utf-8");

			JSONObject params = JSONObject.fromObject(operation);
			return saveLinkRule(params);
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "[" + operation + "]解析失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}
	
	@Put
	public Representation putMethod(Representation entity) {
		JSONObject ret = new JSONObject();

		Form form = entity == null ? null : new Form(entity);
		String operation = null;
		try {
			operation = form.getQueryString();
			operation = URLDecoder.decode(operation, "utf-8");
			operation = new String(operation.getBytes("iso-8859-1"), "utf-8");
			JSONObject params = JSONObject.fromObject(operation);
			return editLinkRule(params);
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "[" + operation + "]解析失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}

	@Delete
	public Representation delMethod(Representation entity) {
		JSONObject ret = new JSONObject();

		String param1 = (String) getRequestAttributes().get("param1");
		if (param1 != null) {
			try {
				param1 = URLDecoder.decode(param1, "utf-8");
			} catch (UnsupportedEncodingException e) {
				log.eLog(e);
				ret.put("message", "[" + param1 + "]解析失败");
				getResponse().setStatus(new Status(600));
				return new JsonRepresentation(ret.toString());
			}
		}

		return deleteLinkRuleById(param1);
	}
	
	/**
	 * 添加匹配规则
	 * 
	 * @param data
	 * @return
	 */
	private Representation saveLinkRule(JSONObject data){
		
		JSONObject ret = new JSONObject();
		//log.iLog("###:"+rule.getConditionJson().toString());
		try{
			//判断规则名称是否已经存在
			List<LinkRule> ruleList = 
					linkRuleService.getRulesByName(data.getString("ruleName"),
							data.getString("ruleType"));
			if(ruleList.size()>0){
				log.eLog("规则名称已经存在");
				ret.put("message", "规则名称已经存在");
				getResponse().setStatus(new Status(600));
				return new JsonRepresentation(ret.toString());
			}
		}catch (Exception e) {
			log.eLog("查询规则名称是否存在时发生错误",e);
			ret.put("message", "保存匹配规则失败");
			getResponse().setStatus(new Status(600));
		}
		
		LinkRule rule = new LinkRule();
		try {
			//规则名称
			rule.setName(data.getString("ruleName"));
			//规则类型
			rule.setRuleType(data.getString("ruleType"));
			//是否激活，默认为激活
			rule.setActive("1");
			//优先级
			rule.setPriority("1");
			//规则条件
			JSONObject condJson = new JSONObject(); 
			//根据规则类型，获取规则条件参数
			if(RuleUtil.PERF_LINK_CI.equalsIgnoreCase(rule.getRuleType())){
				condJson.put("perfValues", data.get("perfValues"));
				condJson.put("perf2CiLink", data.get("perf2CiLink"));
				condJson.put("ciValues", data.get("ciValues"));
			}else{
				condJson.put("perfValues", data.get("perfValues"));
				condJson.put("perf2KpiLink", data.get("perf2KpiLink"));
				condJson.put("kpiValues", data.get("kpiValues"));
			}
			rule.setConditionJson(condJson);
			//保存规则
			linkRuleService.saveLinkRule(rule);
			ret.put("message", "保存匹配规则[" + rule.getName() + "]成功");
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "保存匹配规则失败");
			getResponse().setStatus(new Status(600));
		}
		
		return new JsonRepresentation(ret.toString());
	}
	
	
	/**
	 * 修改匹配规则
	 * 
	 * @param data
	 * @return
	 */
	private Representation editLinkRule(JSONObject data){
		
		JSONObject ret = new JSONObject();
		try {
			String ruleId = data.getString("id");
			//获取到要更新的rule
			LinkRule rule = linkRuleService.getRuleById(ruleId);
			
			//规则名称
			//rule.setName(data.getString("ruleName"));
			//规则类型
			rule.setRuleType(data.getString("ruleType"));
			
			//规则条件
			JSONObject condJson = new JSONObject(); 
			//根据规则类型，获取规则条件参数
			if(RuleUtil.PERF_LINK_CI.equalsIgnoreCase(rule.getRuleType())){
				condJson.put("perfValues", data.get("perfValues"));
				condJson.put("perf2CiLink", data.get("perf2CiLink"));
				condJson.put("ciValues", data.get("ciValues"));
			}else{
				condJson.put("perfValues", data.get("perfValues"));
				condJson.put("perf2KpiLink", data.get("perf2KpiLink"));
				condJson.put("kpiValues", data.get("kpiValues"));
			}
			rule.setConditionJson(condJson);
			
			//修改规则
			linkRuleService.editLinkRule(rule);
			ret.put("message", "修改匹配规则[" + rule.getName() + "]成功");
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "修改匹配规则失败");
			getResponse().setStatus(new Status(600));
		}
		
		return new JsonRepresentation(ret.toString());
	}
	
	/**
	 * 删除匹配规则
	 * 
	 * @param data{id:ruleId}
	 * @return
	 */
	private Representation deleteLinkRuleById(String ruleId){
		JSONObject ret = new JSONObject();
		try {
			
			linkRuleService.deleteLinkRule(ruleId);
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "删除匹配规则失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}
	
	/**
	 * 返回一个json格式的匹配规则列表
	 * 
	 * @param ruleType 规则类型
	 * @return Representation 
	 * @throws Exception
	 */
	private Representation getRulesByType(String ruleType) {
		JSONObject ret = new JSONObject();
		try {
			List<LinkRule> ruleList = linkRuleService.getRulesByType(ruleType);
			JSONArray list = new JSONArray();
			for (LinkRule rule : ruleList) {
				Map<String, Object> ruleMap = rule.rule2Map();
				list.add(ruleMap);
			}
			ret.put("data", list);
			ret.put("message", "获取全部["+ruleType+"]匹配规则成功");
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "获取全部["+ruleType+"]匹配规则失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}
	
	
	/**
	 * 通过唯一id获取匹配规则
	 * 
	 * @param id
	 * @return
	 * @throws Exception
	 */
	private Representation getRuleById(String id) {
		JSONObject ret = new JSONObject();
		try {
			LinkRule linkRule = linkRuleService.getRuleById(id);
			if (linkRule != null) {
				Map<String, Object> asMap = linkRule.rule2Map();

				ret.put("data", asMap);
				ret.put("message", "获取匹配规则[" + id + "]成功");
			} else {
				ret.put("message", "获取匹配规则[" + id + "]失败");
				getResponse().setStatus(new Status(600));
			}
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "获取匹配规则[" + id + "]失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}
}
