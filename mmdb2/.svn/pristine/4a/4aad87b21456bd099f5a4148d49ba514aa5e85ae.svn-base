package com.mmdb.rest.subscription;

import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import net.sf.json.JSONObject;

import org.apache.commons.collections.comparators.ComparatorChain;
import org.restlet.Context;
import org.restlet.Request;
import org.restlet.Response;
import org.restlet.data.Header;
import org.restlet.data.Status;
import org.restlet.ext.json.JsonRepresentation;
import org.restlet.representation.Representation;
import org.restlet.resource.Delete;
import org.restlet.resource.Get;
import org.restlet.resource.Post;
import org.restlet.resource.ServerResource;
import org.restlet.util.Series;

import com.mmdb.core.log.Log;
import com.mmdb.core.log.LogFactory;
import com.mmdb.core.utils.SpringContextUtil;
import com.mmdb.model.bean.User;
import com.mmdb.model.info.ViewInformation;
import com.mmdb.model.info.ViewPortfolio;
import com.mmdb.service.info.IViewInfoService;
import com.mmdb.service.info.IViewPortfolioService;
import com.mmdb.service.relation.IViewViewProtfolioRelService;
import com.mmdb.service.role.IUserService;
import com.mmdb.service.role.impl.UserService;
import com.mmdb.service.subscription.ISubscriptionService;
import com.mmdb.service.subscription.ISubscriptionViewPortfolioService;
import com.mmdb.util.des.Des;

/**
 * 用于管理订阅,可以订阅视图和组合视图
 * 
 * @author xiongjian
 * @path /subscription/view
 */
public class SubscriptionPortfolioViewRest extends ServerResource {
	private Log log = LogFactory.getLogger("SubscriptionRest");
	private IUserService userService;
	private IViewInfoService vInfoService;
	private IViewPortfolioService vpService;
	private IViewViewProtfolioRelService viewRelToProtService;
	private ISubscriptionService subViewService;
	private ISubscriptionViewPortfolioService subViewPortService;

	@Override
	public void init(Context context, Request request, Response response) {
		super.init(context, request, response);
		userService = (IUserService) SpringContextUtil.getApplicationContext()
				.getBean("userService");
		vInfoService = (IViewInfoService) SpringContextUtil
				.getApplicationContext().getBean("viewInfoService");

		vpService = (IViewPortfolioService) SpringContextUtil
				.getApplicationContext().getBean("viewPortfolioService");

		viewRelToProtService = (IViewViewProtfolioRelService) SpringContextUtil
				.getApplicationContext().getBean(
						"viewViewProtfolioRelServiceImpl");
		subViewService = (ISubscriptionService) SpringContextUtil
				.getApplicationContext().getBean("subscriptionService");

		subViewPortService = (ISubscriptionViewPortfolioService) SpringContextUtil
				.getApplicationContext().getBean(
						"subscriptionViewPortfolioService");
	}

	@Post
	public Representation postMethod(Representation entity) {
		JSONObject ret = new JSONObject();
		// action
		String param1 = (String) getRequestAttributes().get("param1");

		if (param1 != null) {
			try {
				param1 = URLDecoder.decode(param1, "utf-8");
			} catch (UnsupportedEncodingException e) {
				log.eLog(e);
				ret.put("message", "[" + param1 + "]解析失败");
				getResponse().setStatus(new Status(600));
			}
		}

		String operation = null;
		try {
			// 订阅视图
			return subscriptionView(param1);
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "[" + operation + "]解析失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}

	@Delete
	public Representation delMethod(Representation entity) {
		JSONObject ret = new JSONObject();
		// action
		String param1 = (String) getRequestAttributes().get("param1");

		if (param1 != null) {
			try {
				param1 = URLDecoder.decode(param1, "utf-8");
			} catch (UnsupportedEncodingException e) {
				log.eLog(e);
				ret.put("message", "[" + param1 + "]解析失败");
				getResponse().setStatus(new Status(600));
			}
		}

		String operation = null;
		try {
			// 订阅视图
			return unsubscriptionView(param1);
		} catch (Exception e) {
			log.eLog(e);
			ret.put("message", "[" + operation + "]解析失败");
			getResponse().setStatus(new Status(600));
		}
		return new JsonRepresentation(ret.toString());
	}

	/**
	 * 订阅视图
	 * 
	 * @param viewPId
	 *            组合视图id
	 * @return
	 */
	private Representation subscriptionView(String viewPId) {
		JSONObject ret = new JSONObject();
		try {
			ViewPortfolio viewPortfolio = vpService.getById(viewPId);
			if (viewPortfolio == null) {
				throw new Exception("组合视图不存在");
			}
			// 将没有订阅的视图订阅一份
			List<String> viewIds = viewRelToProtService
					.getViewIdByProtfolio(viewPId);
			User user = getUser();
			// 已经订阅的视图id
			List<String> subViewIds = subViewService.getViewBySubscriber(user
					.getLoginName());
			for (String viewId : viewIds) {
				// 将没有订阅的视图订阅一遍
				if (!subViewIds.contains(viewId)) {
					subViewService.save(user.getLoginName(), viewId);
				}
			}

			// 订阅这个组合视图
			subViewPortService.save(viewPId, user.getLoginName());
			ret.put("message", "订阅成功");
		} catch (Exception e) {
			ret.put("message", e.getMessage());
			getResponse().setStatus(new Status(600));
		}

		return new JsonRepresentation(ret.toString());
	}

	/**
	 * 
	 * @param viewPId
	 *            组合视图id
	 * @return
	 */
	private Representation unsubscriptionView(String viewPId) {
		JSONObject ret = new JSONObject();
		try {
			subViewPortService.del(viewPId, getUser().getLoginName());
			ret.put("message", "取消订阅成功");
		} catch (Exception e) {
			ret.put("message", e.getMessage());
			getResponse().setStatus(new Status(600));
		}

		return new JsonRepresentation(ret.toString());
	}



	public User getUser() {
		Series<Header> headers = getRequest().getHeaders();
		String values = headers.getValues("token");
		if (values == null || "".equals(values))
			return null;
		Des des = new Des();
		String decrypt = des.decrypt(values);
		System.out.println(decrypt);
		String[] split = decrypt.split("\\|");
		return userService.getUserByLoginName(split[0]);
		// User user = new User();
		// user.setUserName("admin");
		// user.setLoginName("admin");
		// return user;
	}
}
