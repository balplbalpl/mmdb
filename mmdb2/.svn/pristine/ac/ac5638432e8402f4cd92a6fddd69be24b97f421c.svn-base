package com.mmdb.service.mapping.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.mmdb.core.framework.neo4j.entity.Dynamic;
import com.mmdb.core.framework.neo4j.proxy.AbstractDomain;
import com.mmdb.core.utils.MapUtil;
import com.mmdb.model.categroy.CiCategory;
import com.mmdb.model.categroy.RelCategory;
import com.mmdb.model.categroy.storage.RelCategoryStorage;
import com.mmdb.model.info.CiInformation;
import com.mmdb.model.mapping.InCiCateMap;
import com.mmdb.model.mapping.storage.InCiCateMapStorage;
import com.mmdb.model.relation.CiRelation;
import com.mmdb.service.info.ICiInfoService;
import com.mmdb.service.mapping.IInCiCateMapService;
import com.mmdb.service.relation.ICiRelService;

@Component("inCiCateMapService")
public class InCiCateMapServiceImpl extends AbstractDomain implements
		IInCiCateMapService {
	@Autowired
	private InCiCateMapStorage imStorage;
	@Autowired
	private ICiInfoService infoService;
	@Autowired
	private ICiRelService relService;
	@Autowired
	private RelCategoryStorage relCategoryStorage;

	@Override
	public List<InCiCateMap> getAll() throws Exception {
		return imStorage.getAll();
	}

	@Override
	public InCiCateMap getByName(String uName) throws Exception {
		return imStorage.getByName(uName);
	}

	@Override
	public InCiCateMap getById(String id) throws Exception {
		return imStorage.getById(id);
	}

	@Override
	public InCiCateMap save(InCiCateMap im) throws Exception {
		return imStorage.save(im);
	}

	@Override
	public void save(List<InCiCateMap> ims) throws Exception {
		for (InCiCateMap im : ims) {
			imStorage.save(im);
		}
	}

	@Override
	public void delete(InCiCateMap im) throws Exception {
		imStorage.delete(im);
	}

	@Override
	public void deleteAll() throws Exception {
		imStorage.deleteAll();
	}

	@Override
	public InCiCateMap update(InCiCateMap im) throws Exception {
		InCiCateMap nim = imStorage.update(im);
		return nim;
	}

	@Override
	public void runNow(InCiCateMap im, List<CiInformation> infos)
			throws Exception {
		// im = im.unLazy();
		CiCategory sCate = im.getStartCate(), eCate = im.getEndCate();
		im.setRelValue(this.paddingRelValue(im));
		imStorage.update(im);
		String sid = sCate.getId(), eid = eCate.getId();
		for (CiInformation info : infos) {
			String cid = info.getCategoryId();
			if (sid.equals(cid)) {
				// 获取起点映射的值
				Object sVal = info.getData().get(im.getStartCateField());
				if (!sVal.equals("")) {
					Map<String, String> map = MapUtil.hashMap(
							im.getEndCateField(),
							(sVal == null ? null : sVal.toString()));
					// 获取终点分类下与起点值相同的终点数据
					List<CiInformation> eInfos = infoService.qureyByAdvanced(
							eCate, map, null, false);
					for (CiInformation eInfo : eInfos) {
						// 新建关系
						// info = info.unLazy();
						// eInfo = eInfo.unLazy();
						CiRelation ir = new CiRelation(info, eInfo, im);
						CiRelation cir = relService.getById(ir.getId());
						if (cir == null) {
							relService.save(ir);
						} else {
							// cir = cir.unLazy();
							cir.setOutMapId(null);
							cir.setRelValue(new Dynamic<String, Object>()
									.from(im.getRelValue()));
							cir.setInMapId(im.getName());
							cir.setRelCateId(im.getRelCate().getId());
							relService.update(cir);
						}
					}
				}
			} else if (eid.equals(cid)) {
				// 获取起点映射的值
				Object sVal = info.getData().get(im.getEndCateField());
				if (!sVal.equals("")) {
					Map<String, String> map = MapUtil.hashMap(
							im.getStartCateField(),
							(sVal == null ? null : sVal.toString()));
					// 获取终点分类下与起点值相同的终点数据
					List<CiInformation> sInfos = infoService.qureyByAdvanced(
							eCate, map, null, false);
					for (CiInformation sinfo : sInfos) {
						// 获取起点映射的值
						// 新建关系
						// sinfo = sinfo.unLazy();
						// info = info.unLazy();
						CiRelation ir = new CiRelation(sinfo, info, im);
						CiRelation cir = relService.getById(ir.getId());
						if (cir == null) {
							relService.save(ir);
						} else {
							// cir = cir.unLazy();
							cir.setOutMapId(null);
							cir.setRelValue(new Dynamic<String, Object>()
									.from(im.getRelValue()));
							cir.setInMapId(im.getName());
							cir.setRelCateId(im.getRelCate().getId());
							relService.update(cir);
						}
					}
				}
			}
		}
	}

	/**
	 * 处理关系属性空值
	 * 
	 * @param im
	 *            CI内部映射
	 * @return
	 */
	private Map<String, Object> paddingRelValue(InCiCateMap im) {
		List<String> attrs = im.getRelCate().getAttributeNames();
		Map<String, Object> relVal = new HashMap<String, Object>();
		Map<String, Object> relValue = im.getRelValue();
		for (String a : attrs) {
			Object obj = null;
			if (relValue.containsKey(a)) {
				obj = relValue.get(a);
				if (obj == null || obj.equals("")) {
					obj = im.getRelCate().getAttributeByName(a)
							.getDefaultValue();
				}
			} else {
				obj = im.getRelCate().getAttributeByName(a).getDefaultValue();
			}
			relVal.put(a, obj);
		}
		return relVal;
	}

	@Override
	public Map<String, Long> runNow(String imId,
			Map<String, CiCategory> ciCateMap,
			Map<String, RelCategory> relCateMap) throws Exception {
		// System.setErr(new PrintStream(new File("d:/a.txt")));
		InCiCateMap im = getById(imId);
		im.setRelCate(relCateMap.get(im.getRelCateId()));
		im.setStartCate(ciCateMap.get(im.getStartCateId()));
		im.setEndCate(ciCateMap.get(im.getEndCateId()));
		long updateTime = 0;
		// im = im.unLazy();
		long ssst = System.currentTimeMillis();
		Map<String, Long> retMap = null;
		// long snum = 0, unum = 0;
		CiCategory sCate = im.getStartCate(), eCate = im.getEndCate();
		RelCategory relCate = im.getRelCate();
		im.setRelValue(this.paddingRelValue(im));
		imStorage.update(im);
		List<CiInformation> sInfos = infoService.qureyByAdvanced(sCate, null,
				null, false);
		Map<Object, List<CiInformation>> eInfoMapCache = new HashMap<Object, List<CiInformation>>();
		Map<String, CiRelation> ciRelMapCache = new HashMap<String, CiRelation>();
		List<CiRelation> ciRelCache = relService.getAll();
		for (CiRelation ciRel : ciRelCache) {
			ciRelMapCache.put(ciRel.getId(), ciRel);
		}
		Set<CiRelation> newCiRel = new HashSet<CiRelation>();
		for (CiInformation sinfo : sInfos) {
			long sst = System.currentTimeMillis();
			// 获取起点映射的值
			Object sVal = sinfo.getData().get(im.getStartCateField());

			if (!sVal.equals("")) {
				Map<String, String> map = MapUtil.hashMap(im.getEndCateField(),
						(sVal == null ? null : sVal.toString()));
				// 获取终点分类下与起点值相同的终点数据
				List<CiInformation> eInfos = eInfoMapCache.get(sVal);
				if (eInfos == null) {
					eInfos = infoService.qureyByAdvanced(eCate, map, null,
							false);
					eInfoMapCache.put(sVal, eInfos);
				}

				for (CiInformation eInfo : eInfos) {
					newCiRel.add(new CiRelation(sinfo, eInfo, im));
				}
			}
			System.err.println("eeeeeeeeeeeeee : "
					+ (System.currentTimeMillis() - sst));
		}
		long st = System.currentTimeMillis();
		retMap = relService.saveOrUpdate(relCate, newCiRel);
		System.err.println("ffffffffff : " + (System.currentTimeMillis() - st));

		System.err.println("runNow 全部执行完成 : "
				+ (System.currentTimeMillis() - ssst));
		return retMap;
	}

	@Override
	public List<InCiCateMap> getByRelCate(RelCategory rc) throws Exception {
		List<InCiCateMap> ims = new ArrayList<InCiCateMap>();
		List<InCiCateMap> cMaps = imStorage.getAll();
		String rl = rc.getName();
		for (InCiCateMap cMap : cMaps) {
			String nid = cMap.getRelCate().getName();
			if (rl.equals(nid)) {
				ims.add(cMap);
			}
		}
		return ims;
	}

	@Override
	public List<String> getRelCateIds() throws Exception {
		List<String> retList = new ArrayList<String>();
		List<InCiCateMap> cMaps = imStorage.getAll();

		List<RelCategory> all = relCategoryStorage.getAll();
		Map<String, RelCategory> cache = new HashMap<String, RelCategory>();
		for (RelCategory relCate : all) {
			cache.put(relCate.getId(), relCate);
		}
		all = null;

		for (InCiCateMap cMap : cMaps) {
			RelCategory relCategory = cache.get(cMap.getRelCateId());
			if (relCategory != null) {
				String nid = relCategory.getName();
				if (!retList.contains(nid)) {
					retList.add(nid);
				}
			}
		}
		return retList;
	}

	@Override
	public List<RelCategory> getRelCates() throws Exception {
		List<RelCategory> retList = new ArrayList<RelCategory>();
		List<InCiCateMap> cMaps = imStorage.getAll();
		for (InCiCateMap cMap : cMaps) {
			RelCategory rt = cMap.getRelCate();
			if (!retList.contains(rt)) {
				retList.add(rt);
			}
		}
		return retList;
	}

	@Override
	public List<InCiCateMap> getMapsByCate(CiCategory category)
			throws Exception {
		List<InCiCateMap> retList = new ArrayList<InCiCateMap>();
		String id = category.getId();
		List<InCiCateMap> cMaps = imStorage.getAll();
		for (InCiCateMap cMap : cMaps) {
			String sid = cMap.getStartCateId();
			String eid = cMap.getEndCateId();
			if (sid.equals(id) || eid.equals(id)) {
				if (!retList.contains(cMap)) {
					retList.add(cMap);
				}
			}
		}
		return retList;
	}

	public boolean exist(String id) {
		return imStorage.exist(id);
	}

	@Override
	public void update(List<InCiCateMap> ims) throws Exception {
		if (ims != null && ims.size() > 0)
			imStorage.update(ims);
	}
}
